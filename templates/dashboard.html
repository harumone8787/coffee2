{% extends 'base.html' %}
{% block title %}在庫一覧 - 在庫管理{% endblock %}
{% block content %}
<h1>在庫一覧</h1>

<!-- 検索・フィルタ（GET） -->
<form method="get" class="grid-form filter-form" action="{{ url_for('inventory.dashboard') }}">
  <div>
    <label>🔎 商品検索（商品名 / 仕入れ先）</label>
    <input name="q" value="{{ q or '' }}" placeholder="例: バラ / 卸A">
  </div>
  <div>
    <label>🧭 履歴の区分</label>
    <select name="kind">
      <option value="" {% if not kind %}selected{% endif %}>すべて</option>
      <option value="IN" {% if kind == 'IN' %}selected{% endif %}>入庫</option>
      <option value="OUT" {% if kind == 'OUT' %}selected{% endif %}>出庫</option>
    </select>
  </div>
  <div>
    <label>📦 履歴の商品</label>
    <select name="prod">
      <option value="">すべて</option>
      {% for fp in filter_products %}
        <option value="{{ fp.id }}" {% if prod_selected == fp.id %}selected{% endif %}>{{ fp.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="full">
    <button type="submit" class="button-accent">この条件で表示</button>
    <a class="button-accent" href="{{ url_for('inventory.dashboard') }}" style="margin-left:8px;">条件クリア</a>
  </div>
</form>

<div class="toolbar">
  <a class="button-secondary" href="{{ url_for('inventory.products') }}">🧾 商品登録/一覧</a>
  <a class="button-secondary" href="{{ url_for('inventory.movements') }}">🔁 入出庫（消費登録）</a>
</div>

<!-- 在庫表（PCもスマホも従来どおりテーブル） -->
<div class="table-responsive">
  <table class="table">
    <thead>
      <tr><th>商品名</th><th>在庫</th><th>単位</th><th>最低在庫数</th><th>仕入れ先</th></tr>
    </thead>
    <tbody>
      {% for p in products %}
        {% set qty = qty_map.get(p.id, 0) %}
        {% set low = qty < (p.min_stock or 0) %}
        <tr class="{{ 'low' if low else '' }}">
          <td class="cell-name">📦 {{ p.name }}</td>
          <td class="cell-stock {{ 'text-red' if low else '' }}">{{ qty }}</td>
          <td class="cell-unit">{{ p.unit }}</td>
          <td class="cell-min">{{ p.min_stock }}</td>
          <td class="cell-supplier">{{ p.supplier or '-' }}</td>
        </tr>
      {% endfor %}
      {% if not products %}
        <tr><td colspan="5" style="color:var(--muted)">該当する商品がありません。</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- 最新の履歴（PC＝テーブル、スマホ＝カード） -->
<h2 class="mt-3">🕒 最新の履歴（10件）</h2>

<!-- PC/タブレット用：従来のテーブル -->
<div class="table-responsive recent-table">
  <table class="table">
    <thead>
      <tr><th>日時</th><th>商品</th><th>区分</th><th>数量</th><th>担当</th><th>メモ</th></tr>
    </thead>
    <tbody>
      {% for m in recent10 %}
      <tr>
        <td>{{ m.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>📦 {{ m.product.name if m.product else '-' }}</td>
        <td>
          {% if m.movement_type == 'in' %}
            <span class="badge badge-green">入庫</span>
          {% else %}
            <span class="badge badge-red">出庫</span>
          {% endif %}
        </td>
        <td class="qty-col">{{ m.quantity }}</td>
        <td>
          {% if m.user and m.user.is_admin %}
            <span class="icon icon-admin" title="管理者">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 14a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/>
              </svg>
            </span>
            <span style="margin-left:6px">{{ m.user.username }}</span>
          {% elif m.user %}
            <span class="icon icon-staff" title="スタッフ">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 14a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/>
              </svg>
            </span>
            <span style="margin-left:6px">{{ m.user.username }}</span>
          {% else %}
            -
          {% endif %}
        </td>
        <td>{{ m.note or '' }}</td>
      </tr>
      {% endfor %}
      {% if not recent10 %}
        <tr><td colspan="6" style="color:var(--muted)">履歴がありません。</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- スマホ用：カード表示（PCでは非表示） -->
<div class="recent-cards">
  {% for m in recent10 %}
  <div class="recent-card">
    <div class="row-top">
      <div class="prod">📦 {{ m.product.name if m.product else '-' }}</div>
      <div class="time">{{ m.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
    </div>
    <div class="row-mid">
      <div class="kind">
        {% if m.movement_type == 'in' %}
          <span class="badge badge-green">入庫</span>
        {% else %}
          <span class="badge badge-red">出庫</span>
        {% endif %}
      </div>
      <div class="qty-pill">
        <span class="qty-num">{{ m.quantity }}</span>
        <span class="qty-label">数量</span>
      </div>
    </div>
    <div class="row-bottom">
      <div class="user">
        {% if m.user and m.user.is_admin %}
          <span class="icon icon-admin" title="管理者">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 14a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/>
            </svg>
          </span>
          <span class="username">{{ m.user.username }}</span>
        {% elif m.user %}
          <span class="icon icon-staff" title="スタッフ">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 14a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/>
            </svg>
          </span>
          <span class="username">{{ m.user.username }}</span>
        {% else %}
          <span class="username">-</span>
        {% endif %}
      </div>
      {% if m.note %}
        <div class="note">📝 {{ m.note }}</div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
  {% if not recent10 %}
    <div class="recent-card empty">履歴がありません。</div>
  {% endif %}
</div>

{% endblock %}
