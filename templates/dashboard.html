{% extends 'base.html' %}
{% block title %}åœ¨åº«ä¸€è¦§ - åœ¨åº«ç®¡ç†{% endblock %}
{% block content %}
<h1>åœ¨åº«ä¸€è¦§</h1>

<!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆGETï¼‰ -->
<form method="get" class="grid-form filter-form" action="{{ url_for('inventory.dashboard') }}">
  <div>
    <label>ğŸ” å•†å“æ¤œç´¢ï¼ˆå•†å“å / ä»•å…¥ã‚Œå…ˆï¼‰</label>
    <input name="q" value="{{ q or '' }}" placeholder="ä¾‹: ãƒãƒ© / å¸A">
  </div>
  <div>
    <label>ğŸ§­ å±¥æ­´ã®åŒºåˆ†</label>
    <select name="kind">
      <option value="" {% if not kind %}selected{% endif %}>ã™ã¹ã¦</option>
      <option value="IN" {% if kind == 'IN' %}selected{% endif %}>å…¥åº«</option>
      <option value="OUT" {% if kind == 'OUT' %}selected{% endif %}>å‡ºåº«</option>
    </select>
  </div>
  <div>
    <label>ğŸ“¦ å±¥æ­´ã®å•†å“</label>
    <select name="prod">
      <option value="">ã™ã¹ã¦</option>
      {% for fp in filter_products %}
        <option value="{{ fp.id }}" {% if prod_selected == fp.id %}selected{% endif %}>{{ fp.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="full">
    <button type="submit" class="button-accent">ã“ã®æ¡ä»¶ã§è¡¨ç¤º</button>
    <a class="button-accent" href="{{ url_for('inventory.dashboard') }}" style="margin-left:8px;">æ¡ä»¶ã‚¯ãƒªã‚¢</a>
  </div>
</form>

<div class="toolbar">
  <a class="button-secondary" href="{{ url_for('inventory.products') }}">ğŸ§¾ å•†å“ç™»éŒ²/ä¸€è¦§</a>
  <a class="button-secondary" href="{{ url_for('inventory.movements') }}">ğŸ” å…¥å‡ºåº«ï¼ˆæ¶ˆè²»ç™»éŒ²ï¼‰</a>
</div>

<!-- åœ¨åº«è¡¨ï¼ˆPCã‚‚ã‚¹ãƒãƒ›ã‚‚å¾“æ¥ã©ãŠã‚Šãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ -->
<div class="table-responsive">
  <table class="table">
    <thead>
      <tr><th>å•†å“å</th><th>åœ¨åº«</th><th>å˜ä½</th><th>æœ€ä½åœ¨åº«æ•°</th><th>ä»•å…¥ã‚Œå…ˆ</th></tr>
    </thead>
    <tbody>
      {% for p in products %}
        {% set qty = qty_map.get(p.id, 0) %}
        {% set low = qty < (p.min_stock or 0) %}
        <tr class="{{ 'low' if low else '' }}">
          <td class="cell-name">ğŸ“¦ {{ p.name }}</td>
          <td class="cell-stock {{ 'text-red' if low else '' }}">{{ qty }}</td>
          <td class="cell-unit">{{ p.unit }}</td>
          <td class="cell-min">{{ p.min_stock }}</td>
          <td class="cell-supplier">{{ p.supplier or '-' }}</td>
        </tr>
      {% endfor %}
      {% if not products %}
        <tr><td colspan="5" style="color:var(--muted)">è©²å½“ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- æœ€æ–°ã®å±¥æ­´ï¼ˆPCï¼ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã‚¹ãƒãƒ›ï¼ã‚«ãƒ¼ãƒ‰ï¼‰ -->
<h2 class="mt-3">ğŸ•’ æœ€æ–°ã®å±¥æ­´ï¼ˆ10ä»¶ï¼‰</h2>

<!-- PC/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ï¼šå¾“æ¥ã®ãƒ†ãƒ¼ãƒ–ãƒ« -->
<div class="table-responsive recent-table">
  <table class="table">
    <thead>
      <tr><th>æ—¥æ™‚</th><th>å•†å“</th><th>åŒºåˆ†</th><th>æ•°é‡</th><th>æ‹…å½“</th><th>ãƒ¡ãƒ¢</th></tr>
    </thead>
    <tbody>
      {% for m in recent10 %}
      <tr>
        <td>{{ m.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>ğŸ“¦ {{ m.product.name if m.product else '-' }}</td>
        <td>
          {% if m.movement_type == 'in' %}
            <span class="badge badge-green">å…¥åº«</span>
          {% else %}
            <span class="badge badge-red">å‡ºåº«</span>
          {% endif %}
        </td>
        <td class="qty-col">{{ m.quantity }}</td>
        <td>
          {% if m.user and m.user.is_admin %}
            <span class="icon icon-admin" title="ç®¡ç†è€…">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 14a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/>
              </svg>
            </span>
            <span style="margin-left:6px">{{ m.user.username }}</span>
          {% elif m.user %}
            <span class="icon icon-staff" title="ã‚¹ã‚¿ãƒƒãƒ•">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 14a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/>
              </svg>
            </span>
            <span style="margin-left:6px">{{ m.user.username }}</span>
          {% else %}
            -
          {% endif %}
        </td>
        <td>{{ m.note or '' }}</td>
      </tr>
      {% endfor %}
      {% if not recent10 %}
        <tr><td colspan="6" style="color:var(--muted)">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- ã‚¹ãƒãƒ›ç”¨ï¼šã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆPCã§ã¯éè¡¨ç¤ºï¼‰ -->
<div class="recent-cards">
  {% for m in recent10 %}
  <div class="recent-card">
    <div class="row-top">
      <div class="prod">ğŸ“¦ {{ m.product.name if m.product else '-' }}</div>
      <div class="time">{{ m.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
    </div>
    <div class="row-mid">
      <div class="kind">
        {% if m.movement_type == 'in' %}
          <span class="badge badge-green">å…¥åº«</span>
        {% else %}
          <span class="badge badge-red">å‡ºåº«</span>
        {% endif %}
      </div>
      <div class="qty-pill">
        <span class="qty-num">{{ m.quantity }}</span>
        <span class="qty-label">æ•°é‡</span>
      </div>
    </div>
    <div class="row-bottom">
      <div class="user">
        {% if m.user and m.user.is_admin %}
          <span class="icon icon-admin" title="ç®¡ç†è€…">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 14a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/>
            </svg>
          </span>
          <span class="username">{{ m.user.username }}</span>
        {% elif m.user %}
          <span class="icon icon-staff" title="ã‚¹ã‚¿ãƒƒãƒ•">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 14a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/>
            </svg>
          </span>
          <span class="username">{{ m.user.username }}</span>
        {% else %}
          <span class="username">-</span>
        {% endif %}
      </div>
      {% if m.note %}
        <div class="note">ğŸ“ {{ m.note }}</div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
  {% if not recent10 %}
    <div class="recent-card empty">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
  {% endif %}
</div>

{% endblock %}
