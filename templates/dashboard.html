{% extends 'base.html' %}
{% block content %}
<div class="container">
  <h2>在庫一覧</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul class="flashes">
        {% for category, message in messages %}
          <li class="flash {{ category }}">{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <!-- 検索フィルタ -->
  <form class="form" method="get" action="{{ url_for('inventory.dashboard') }}">
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <input type="text" name="q" value="{{ filter_products or '' }}" placeholder="商品名で検索">
      <button class="button-accent" type="submit">検索</button>
      <a class="navlink" href="{{ url_for('inventory.dashboard') }}">クリア</a>
      <a class="navbtn" href="{{ url_for('inventory.products') }}">商品登録/一覧</a>
      <a class="navbtn" href="{{ url_for('inventory.movements') }}">入出庫</a>
    </div>
  </form>

  <!-- 在庫テーブル -->
  <div class="table-responsive mt-2">
    <table class="table">
      <thead>
        <tr>
          <th>商品名</th>
          <th>在庫</th>
          <th>単位</th>
          <th>最小在庫</th>
          <th>仕入れ先</th>
        </tr>
      </thead>
      <tbody>
        {% for p in products %}
          {% set qty = qty_map.get(p.id, 0) %}
          <tr class="{{ 'low' if qty < (p.min_stock or 0) else '' }}">
            <td class="cell-name">{{ p.name }}</td>
            <td>
              {% if qty < (p.min_stock or 0) %}
                <span class="text-red">{{ qty }}</span>
              {% else %}
                {{ qty }}
              {% endif %}
            </td>
            <td>{{ p.unit or '-' }}</td>
            <td>{{ p.min_stock or 0 }}</td>
            <td>{{ p.supplier or '-' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- 最新入出庫 10件 -->
  <h3 class="mt-3">最近の入出庫（最新10件）</h3>
  <div class="table-responsive">
    <table class="table">
      <thead>
        <tr>
          <th>日時</th>
          <th>商品</th>
          <th>区分</th>
          <th>数量</th>
          <th>担当</th>
          <th>メモ</th>
        </tr>
      </thead>
      <tbody>
        {% if recent_movements %}
          {% for m in recent_movements %}
          <tr>
            <td>{{ m.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>{{ m.product.name if m.product else '-' }}</td>
            <td>
              {% if m.movement_type == 'in' %}
                <span class="badge badge-green">入庫</span>
              {% else %}
                <span class="badge badge-red">出庫</span>
              {% endif %}
            </td>
            <td>{{ m.quantity }}</td>
            <td>{{ m.user.username if m.user else '-' }}</td>
            <td>{{ m.note or '' }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="6">まだ入出庫履歴がありません。</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
